
  {name}:
    name: {display_name}
    runs-on: ubuntu-latest
    #needs: pre-commit

    timeout-minutes: 480

    steps:
    - uses: actions/checkout@v2

    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 2.6

    - name: Set Env Keys
      run: |
        echo "::set-env name=RUBY::$(ruby --version | sha256sum | cut -d' ' -f1)"
        echo "::set-env name=BUNDLE_WITH::docker"
        echo "::set-env name=BUNDLE_WITHOUT::ec2 vagrant windows"

    - name: Set Cache Key
      run: |
        echo "RUBY=${{{{ env.RUBY }}}}"
        echo "BUNDLE_WITH=${{{{ env.BUNDLE_WITH }}}}"
        echo "BUNDLE_WITHOUT=${{{{ env.BUNDLE_WITHOUT }}}}"
        echo "::set-env name=BUNDLE_CACHE_KEY::$(echo ${{{{ env.RUBY }}}} ${{{{ env.BUNDLE_WITH }}}} ${{{{ env.BUNDLE_WITHOUT }}}} | sha256sum | cut -d' ' -f1)"

    - uses: actions/cache@v1
      with:
        path: vendor/bundle
        key: bundle-use-ruby-${{{{ runner.os }}}}-${{{{ env.BUNDLE_CACHE_KEY }}}}-${{{{ hashFiles('**/Gemfile.lock') }}}}
        restore-keys: |
          bundle-use-ruby-${{{{ runner.os }}}}-${{{{ env.BUNDLE_CACHE_KEY }}}}-

    - name: bundle install
      run: |
        set -e
        set -x
        bundle config path vendor/bundle
        bundle config set with ${{{{ env.BUNDLE_WITH }}}}
        bundle config set without ${{{{ env.BUNDLE_WITHOUT }}}}
        bundle install --jobs 4 --retry 3

    - name: Generate SSH Key
      run: |
        set -e
        set -x
        ssh-keygen -t rsa -b 4096 -C "Test Kitchen Key" -f ~/.ssh/id_rsa -q -N ""

    - name: Converge Test Container
      env:
        SALT_DOCKER_IMAGE: 'saltstack/ci-{slug}'
      run: |
        set -e
        set -x
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        bundle exec kitchen converge --debug py3-{slug}

    - name: Run Tests
      env:
        NOX_ENV_NAME: '{nox_env_name}'
        NOX_PASSTHROUGH_OPTS: '{nox_passthrough_opts}'
        SALT_DOCKER_IMAGE: 'saltstack/ci-{slug}'
      run: |
        set -e
        set -x
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        bundle exec kitchen verify --debug py3-{slug}

    - name: Destroy Test Container
      if: always()
      run: |
        set -e
        set -x
        eval "$(ssh-agent -s)"
        ssh-add ~/.ssh/id_rsa
        bundle exec kitchen destroy py3-{slug}

    - uses: actions/upload-artifact@v1
      with:
        name: artifacts
        path: artifacts/
